---
title: |
  |
  |
  | Multilevel/Hierarchical Modeling
  |
  |
author: |
  | Advanced Topics in Quant Social Research
  |
output:
  beamer_presentation:
    includes:
      in_header: mystyle.tex
  slidy_presentation: default
  ioslides_presentation: default
fontsize: 10pt
---

# Linear regression and its extension

\begin{itemize}
  \item What is linear regression ($Y=\alpha+\beta X+\epsilon$)?
  \item What can linear regression do?
  \begin{itemize}
    \item For \textbf{prediction}: The main concern is $\widehat{Y}$; 
    \item To show the marginal effect of $X$ on $Y$: The main concern is to identify the conditions under which $\widehat{\beta}$ is causally valid; 
    \item Searching for the "best" \textbf{data generation process} (DGP) of $Y$: The main concern is the functional form; go for \textbf{non-linear} and {multilevel} modeling.
  \end{itemize}
  \item What are the key assumptions? Why do we need them? Which assumptions are the most (or least) important ones? How should we test these assumptions -- can we and should we? What will happen if we relax (any of) the assumptions?
\end{itemize}

# Linear regression and its extension

\begin{itemize}
  \item For \textbf{prediction}: Go for \textbf{maching learning} (forecasting, pattern recognition and classification).
  \item To show the marginal effect of $X$ on $Y$: Go for \textbf{causal inference}.
  \item Searching for the "best" \textbf{data generation process} (DGP) of $Y$: Go for \textbf{non-linear} and {multilevel} modeling.
  \begin{itemize}
    \item Linear regression with polynomial terms, say $$Y=\alpha+\beta_1X+\beta_2X^2+\epsilon.$$
    \item Generalized linear models for discrete and categorical variables, say $$\log\left(\frac{p}{1-p}\right)=\alpha+\beta_1X+\epsilon.$$
    \item Multilevel (aka hierarchical aka mixed effects) models for when we have \textbf{nested data}.
  \end{itemize}
\end{itemize}

# Why multilevel modeling

\begin{itemize}
  \item Very often, we can detect some nuanced (not necessarily complicated) structure in our data. Say:
  \begin{itemize}
    \item Vote choices across different respondents in a national survey can be grouped by state.
    \item Exam marks across different students in a secondary school can be grouped by teacher.
    \item Local public goods provision records across different villages can be grouped by constituency.
    \item ...What else?
  \end{itemize}
  \pause
  \item How does multilevel modeling matter or come to rescue?
   \begin{itemize}
    \item \textbf{Practical motivation}: The underlying intercept and slope we try to uncover via OLS may depend on the group of focus.
    \item \textbf{Theoretical motivation}: Nested data may and can violate the basic assumptions of linear regression (esp. equal variance and independence of errors).
  \end{itemize}
\end{itemize}

# Prototypes of multilevel models

\begin{itemize}
  \item We want to know whether race influences individual's approval rating (0-100 pts) for the President of the United States.
  \begin{itemize}
    \item Predictor ($X$): `race` (e.g., Asian American, etc).
    \item Outcome ($Y$): `approval`.
    \item Grouping: `state` (e.g., California).
  \end{itemize}
  \vspace{0.5cm}
  \item Let's consider several modeling choices.
\end{itemize}

# Prototypes of multilevel models

|                                    | Formal expression             |
|------------------------------------|--------------------|
| Linear (fixed $\alpha$ and $\beta$) | $Y=\alpha+\beta X+\epsilon$ |
| Linear Multilevel (varying $\alpha$ only) | $Y=\alpha_i+\beta X+\epsilon$ |
| Linear Multilevel (varying $\beta$ only) | $Y=\alpha+\beta_i X+\epsilon$ |
| Linear Multilevel (varying $\alpha$ and $\beta$ only) | $Y=\alpha_i+\beta_i X+\epsilon$ |

|                                     | `R` code              |
|-------------------------------------|-----------------------|
| Linear (fixed $\alpha$ and $\beta$) | `lm(y~x)`             |
| Linear Multilevel (varying $\alpha$)| `lmer(y~x+(1|state))` |
| Linear Multilevel (varying $\beta$) | `lmer(y~x+(0+x|state))` |
| Linear Multilevel (varying $\alpha$ and $\beta$) | `lmer(y~x+(1+x|state))` |

# Why different names?

\begin{itemize}
  \item Multilevel or hierarchical models: Used to highlight the fact that that we are trying to analyze \textbf{nested} data.
  \vspace{0.5cm}
  \item Mixed-effect models: Used to highlight the fact that $\alpha$ and $\beta$ can "vary" by group, depending on how we set up the model.
  \begin{itemize}
    \item The varying $\alpha$ consists of a fixed element (same for all groups) and a random element (each group has a different value).
    \item The varying $\beta$ consists of a fixed element (same for all groups) and a random element (each group has a different value).
  \end{itemize}
\end{itemize}

# Visualization of (linear) multilevel models

```{r echo=FALSE, out.width="95%", fig.align="center"}
knitr::include_graphics("Figs/animation.pdf")
```
\vspace{0.1cm}
\begin{center}
\begin{scriptsize}
\textbf{\url{http://mfviz.com/hierarchical-models/}}
\end{scriptsize}
\end{center}

# Some additiional modeling considerations

\begin{itemize}
  \item Should we include \textbf{group}-level predictors? Short answer: Yes (many researchers do so).
  \vspace{0.1cm}
  \item Should we use \textbf{linear} multilevel models? Short answer: Of course (there is logit multilevel regression).
  \vspace{0.1cm}
  \item What if there are \textbf{multiple} levels or many alternative ways of grouping observations, such as \textbf{time} and \textbf{location}? Short answer: Be my guest (but you want to think about the trade-off).
  \vspace{0.1cm}
  \item Can we use multilevel modeling for \textbf{longitudinal data analysis}? Short answer: Yes (but be extremely cautious -- you may be entering a territory where few people are in now).
\end{itemize}

# Caveats

\begin{itemize}
  \item As in the case of all other modeling techniques, we should keep the following caveats in mind:
  \begin{itemize}
    \item Hypothesis testing is a headache, if not impossible -- rigorous thinking is needed to derive the p-values and their corresponding levels of statistical significance. Potential solution: \textbf{Bayesian} multilevel modeling.
    \item The results may be driven by influential observations or outliers when the number of observations varies too much across different groups.
    \item The model may become unnecessarily intractable (formally and computationally) when it gets too complicated.
    \item It may not be easy to have a set of clear priors to make a decision which model performs or works better -- again, what does that mean to say a model is "better" than other alternatives?
  \end{itemize}
  \vspace{0.2cm}
  \item Extra: For more discussion, see \textbf{Gelman and Hill} (2007) -- focus on Chapters 11-13.
\end{itemize}

# Recap: Multilevel/hierarchical modeling

\begin{itemize}
  \item Linear multilevel regression is an extension of (classical) linear regression (OLS).
  \item Linear multilevel regression can be used to analyze \textbf{nested data} (see below) by allowing observations in each cluster or group to have a unique fitted line (i.e., varying intercepts and/or slopes).
  \item Pros and cons
  \begin{itemize}
    \item Pros: Versatile, flexible and nuanced.
    \item Cons: Formal and computational tractability (complicated and time-consuming); hypothesis testing can be challenging (so go \textbf{Bayesian} please).
  \end{itemize}
\end{itemize}
```{r echo=FALSE, out.width="70%", fig.align="center"}
knitr::include_graphics("Figs/example.pdf")
```

# Example: Years of experiences and salaries across 5 depts

```{r echo=FALSE, out.width="101%", fig.align="center"}
knitr::include_graphics("Figs/lmm.pdf")
```

# Multivariate v multilvel linear regression

We want to use regression to explain $\text{var}(Y)$; the model's explanatory power can be improved by
\vspace{0.3cm}

\begin{itemize}
  \item Bivariate v multivariate: increasing the number of predictors (dimensions).
  \item Classical (single-) v multi-level: increasing the number of levels (hierarchies).
\end{itemize}

\vspace{0.3cm}
|                                    | Classical     | Multi-level  |
|------------------------------------|---------------|--------------|
| Bivariate (one predictor)          | `lm()`        | `lmer()`     |
| Multivariate (more than predictor) | `lm()`        | `lmer()`     |

# Classicial regression (fixed intercept and slopes)

\begin{itemize}
  \item Bivariate (one predictor): $Y=\alpha+\beta X+\epsilon$.
  \item Multivariate (two predictors): $Y=\alpha+\beta_1 X_1++\beta_2 X_2+\epsilon$.
\end{itemize}
\vspace{0.4cm}
```{r echo=FALSE, out.width="90%", fig.align="center"}
knitr::include_graphics("Figs/compare.pdf")
```





# Multilevel regression (varying intercept and/or slopes)

\begin{itemize}
  \item Bivariate (one predictor; $Y=\alpha+\beta X+\epsilon$): there will be 3 multilevel models if one would like to varying $\alpha$ and/or $\beta$ across groups.
  \begin{itemize}
    \item Varying $\alpha$: $Y=\alpha_j+\beta X+\epsilon$.
    \item Varying $\beta$: $Y=\alpha+\beta_j X+\epsilon$.
    \item Varying $\alpha$ and $\beta$: $Y=\alpha_j+\beta_j X+\epsilon$.
  \end{itemize}
  \vspace{0.3cm}
  \item Multivariate (two predictors; $Y=\alpha+\beta_1 X_1++\beta_2 X_2+\epsilon$): there will be 7 multilevel models if one would like to varying $\alpha$, $\beta_1$, and/or $\beta_2$ across groups.
  \vspace{0.3cm}
  \pause
  \item For any baseline linear regression (fixed intercepts and slopes), there will be $2^k-1$ multilevel models one can fit (where $k$ refers to the number of predictors).
\end{itemize}

# Why linear "multilevel" regression

\begin{itemize}
  \item Practical motivation.
  \begin{itemize}
    \item When observations can be nested into different groups (or clusters).
    \item The statistical relationship between $Y$ and predictors ($X$s) can be different across different groups.
  \end{itemize}
  \vspace{0.4cm}
  \item Theoretical motivation.
  \begin{itemize}
    \item When observations can be nested into different groups (or clusters).
    \item Using linear regression to fit nested data can generate errors that violate the assumptions for OLS to be BLUE.
  \end{itemize}
\end{itemize}

# Assumptions for linear regression to be BLUE (skip)

\begin{itemize}
  \item Linearity and addivity: $Y$ is a linear function of the predictor(s).
  \item Normality, homoscedasticity, and independence of $\epsilon$.
  \begin{itemize}
    \item The residuals should be normally distributed; that is, probabilistically the model not produce extreme errors.
    \item The residuals should have equal variance; that is, errors should not be predictable; if violated, $\widehat{\beta}$ can be biased.
    \item The residuals should have equal variance; that is, the errors should not depend on each other.
  \end{itemize}
\end{itemize}

|                                    | Diagnostics                                          |
|------------------------------------|------------------------------------------------------|
| PG Certificate                     | V                                                    |
| Normality $\epsilon$               | Quantile-quantile plot                               |
| Homoscedasticity of $\epsilon$     | Residual plots ($\widehat{Y}$ or $X$ vs $\epsilon$)  |
| Independence of $\epsilon$         | Ad hoc statistics (e.g., Durbin–Watson)              |

# Assumptions for linear regression to be BLUE

\begin{itemize}
  \item In real life, nested data is quite common.
  \vspace{0.3cm}
  \item Using linear regression to analysis nested data can be problematic, because the error of an observation may be determined by the group to which it belongs to (hence no \textbf{homoscedasticity} and/or \textbf{independence}).
  \vspace{0.3cm}
  \item Linear multilevel regression allows us to use linear functions to model nested data. 
\end{itemize}

# Example: Gelman et al (2008)

\begin{itemize}
  \item "How is income related to individual's vote choice?"
  \item Results from multilevel regression show that \textbf{income matters more in red (i.e., Republican) America}.
\end{itemize}
\vspace{0.2cm}
```{r echo=FALSE, out.width="70%", fig.align="center"}
knitr::include_graphics("Figs/qjps.pdf")
```

# Example: Blaydes and Linzer (2012)

\begin{itemize}
  \item "How is religiosity related to anti-Americanism among Muslims?"
  \item Religiosity is positively correlated with sentiment against the US when \textbf{a country is polarized over religious–secular issue dimension}.
\end{itemize}
\vspace{0.2cm}
```{r echo=FALSE, out.width="100%", fig.align="center"}
knitr::include_graphics("Figs/apsr.pdf")
```

# Extra: Advanced multilevel modeling

\begin{itemize}
  \item What if we want to include group-level predictors (Gelman and Hill 2007)? 
  \item What if there are clusters across levels -- should we include all of them (Finch et al 2014)? For instance,
  \begin{itemize}
    \item In administrative data, \textbf{towns} can be nested into \textbf{municipalities}, which can then be nested into \textbf{provinces}.
    \item In a cross-national survey, \textbf{respondents} can be nested into \textbf{countries}, which can then be bested into \textbf{continents}.
  \end{itemize}
  \vspace{0.2cm}
  \item What if the observations can be nested into groups and time (Fairbrother 2013)?
  \vspace{0.2cm}
  \item What if we want to include group-level predictors? -- group-level estimates can be problematic when we do not have too many groups (Bryan et al 2016).
\end{itemize}

# Extra: Advanced multilevel modeling

\begin{itemize}
  \item What if we want to include group-level predictors (Gelman and Hill 2007)? 
  \item What if there are clusters across levels -- should we include all of them (Finch et al 2014)? 
  \vspace{0.2cm}
  \item What if the observations can be nested into groups and time (Fairbrother 2013)?
  \begin{itemize}
    \item In longitudinal cross-national survey, you may have \textbf{repeated measures of each respondent} (e.g., education and income) across different \textbf{countries} over the \textbf{years}.
    \item In longitudinal school data, you may have \textbf{repeated measures of each student} (e.g., race and exam mark) across different \textbf{schools} over the \textbf{semesters}.
  \end{itemize}
  \vspace{0.2cm}
  \item What if we want to include group-level predictors? -- the estimates at the group level can be problematic when we do not have too many groups (Bryan et al 2016).
\end{itemize}
